<!DOCTYPE html>
<html lang="zh-tw">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="app"></div>
    <br />
    <div>——《鬆綁你的焦慮習慣》 Readmoo讀墨電子書</div>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="text/babel">
      const root = ReactDOM.createRoot(document.getElementById("app"));
      class List extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            list: [],
            option1Value: 0,
            option2Value: 0,
            option3Value: 0,
          };
        }
        componentDidMount() {
          fetch("./data.json")
            .then((res) => res.json())
            .then((res) => {
              this.setState({
                ...this.state,
                list: res.map((i) => ({ ...i, value: [0, 0, 0] })),
              });
              console.log(this.state);
            });
        }

        changeCheckbox(topicIndex, index, value) {
          const list = [...this.state.list];
          const listValue = [...list[topicIndex].value];
          const currentListValue = listValue[index];

          const setValue = (newValue, currentValue, values) => {
            const conditions = [
              currentListValue === newValue,
              !values.every((v) => v !== newValue),
            ];
            return conditions.some((e) => e) ? 0 : newValue;
          };

          listValue[index] = setValue(value, currentListValue, listValue);
          list[topicIndex].value = listValue;
          this.setState({ ...this.state, list });
          const [optionValue1, optionValue2, optionValue3] = list
            .map(({ value }) => value)
            .reduce(
              (acc, cur) => {
                acc[0] += cur[0];
                acc[1] += cur[1];
                acc[2] += cur[2];
                return acc;
              },
              [0, 0, 0]
            );
          this.setState({
            ...this.state,
            optionValue1,
            optionValue2,
            optionValue3,
          });
        }

        render() {
          return (
            <div>
              <ul>
                {this.state.list.map((item, topicIndex) => (
                  <li key={item.topic}>
                    {item.topic}
                    {item.options.map((option, index) => (
                      <div key={index}>
                        <br />
                        <label>1</label>
                        <input
                          type="checkbox"
                          checked={item.value[index] === 1}
                          onChange={() =>
                            this.changeCheckbox(topicIndex, index, 1)
                          }
                          name={`${topicIndex}-${index}`}
                        />
                        <label>2</label>
                        <input
                          type="checkbox"
                          checked={item.value[index] === 2}
                          onChange={() =>
                            this.changeCheckbox(topicIndex, index, 2)
                          }
                          name={`${topicIndex}-${index}`}
                        />
                        <label>3</label>
                        <input
                          type="checkbox"
                          checked={item.value[index] === 3}
                          onChange={() =>
                            this.changeCheckbox(topicIndex, index, 3)
                          }
                          name={`${topicIndex}-${index}`}
                        />
                        <br />
                        {option}
                      </div>
                    ))}
                    <hr />
                  </li>
                ))}
              </ul>
              <div>
                接近：{this.state.optionValue1 || "0"} <br />
                躲避：{this.state.optionValue2 || "0"} <br />
                隨波逐流：{this.state.optionValue3 || "0"}
              </div>
            </div>
          );
        }
      }
      root.render(<List />);
    </script>
  </body>
</html>
